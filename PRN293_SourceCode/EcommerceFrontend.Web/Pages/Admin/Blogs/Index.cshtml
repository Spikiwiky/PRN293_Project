@page
@model EcommerceFrontend.Web.Pages.Admin.Blogs.IndexModel
@{
    ViewData["Title"] = "Blog Management";
}

<div class="container-fluid px-4">
    <h1 class="mt-4">Blog Management</h1>
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div><i class="fas fa-table me-1"></i>Blogs List</div>
            <a asp-page="./Create" class="btn btn-primary">Create New Blog</a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Content Preview</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var blog in Model.BlogsResponse.Items)
                        {
                            <tr>
                                <td>@blog.BlogId</td>
                                <td>@blog.Title</td>
                                <td>@(blog.Category?.BlogCategoryTitle ?? "Uncategorized")</td>
                                <td class="content-preview-cell" data-full-content="@Html.Raw(blog.ContentPreview)">
                                    @{
                                        var plainText = System.Net.WebUtility.HtmlDecode(
                                        System.Text.RegularExpressions.Regex.Replace(
                                        blog.ContentPreview ?? "", "<.*?>", " "
                                        ));
                                        var words = plainText.Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries);
                                        var preview = words.Length > 10
                                        ? string.Join(" ", words.Take(10)) + "..."
                                        : plainText;
                                    }
                                    <span class="preview-text">@preview</span>
                                    @if (words.Length > 10)
                                    {
                                        <a href="#" class="show-more-link">Show More</a>
                                    }
                                </td>
                                <td>@blog.CreatedAt.ToString("yyyy-MM-dd")</td>
                                <td>
                                    <div class="btn-group">
                                        <a asp-page="./Edit" asp-route-id="@blog.BlogId" class="btn btn-sm btn-primary">Edit</a>
                                        <a asp-page="./Delete" asp-route-id="@blog.BlogId" class="btn btn-sm btn-danger">Delete</a>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (Model.BlogsResponse.TotalCount > 0)
            {
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        @if (Model.BlogsResponse.Page > 1)
                        {
                            <li class="page-item">
                                <a class="page-link" href="?page=@(Model.BlogsResponse.Page - 1)&pageSize=@Model.BlogsResponse.PageSize">Previous</a>
                            </li>
                        }

                        @for (int i = 1; i <= Math.Ceiling((double)Model.BlogsResponse.TotalCount / Model.BlogsResponse.PageSize); i++)
                        {
                            <li class="page-item @(i == Model.BlogsResponse.Page ? "active" : "")">
                                <a class="page-link" href="?page=@i&pageSize=@Model.BlogsResponse.PageSize">@i</a>
                            </li>
                        }

                        @if (Model.BlogsResponse.Page < Math.Ceiling((double)Model.BlogsResponse.TotalCount / Model.BlogsResponse.PageSize))
                        {
                            <li class="page-item">
                                <a class="page-link" href="?page=@(Model.BlogsResponse.Page + 1)&pageSize=@Model.BlogsResponse.PageSize">Next</a>
                            </li>
                        }
                    </ul>
                </nav>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Toggle content preview
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.show-more-link').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const cell = this.closest('.content-preview-cell');
                    const previewText = cell.querySelector('.preview-text');

                    if (this.textContent === 'Show More') {
                        previewText.innerHTML = cell.dataset.fullContent;
                        this.textContent = 'Show Less';
                    } else {
                        const plainText = cell.dataset.fullContent
                            .replace(/<[^>]*>/g, ' ')
                            .replace(/\s+/g, ' ').trim();
                        const words = plainText.split(' ');
                        previewText.textContent = words.slice(0, 10).join(' ') + '...';
                        this.textContent = 'Show More';
                    }
                });
            });
        });
    </script>

    <style>
        .content-preview-cell {
            max-width: 300px;
            word-break: break-word;
        }

        .show-more-link {
            color: #007bff;
            text-decoration: none;
            font-size: 0.85rem;
            margin-left: 5px;
            cursor: pointer;
        }

            .show-more-link:hover {
                text-decoration: underline;
            }
    </style>
}
